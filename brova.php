<?php
  set_time_limit(0);

  $conn = new mysqli('mariadb-masterbus-trafico.planisys.net', 'c0mbexpuser', 'Mb2013Exp', 'c0mbexport');
  mysqli_query($conn, "SET NAMES 'utf8'");


  $sql = "SELECT o.*, if (edd.id is not null, hcitacionreal, hcitacion) as orden FROM( (SELECT interno, upper(c.razon_social)as razon_social, 0 as id_cond, fservicio as fsrv, upper(servicio) as servicio, date_format(hsalida, '%H:%i') as hsalida, o.id, date_format(fservicio, '%d/%m/%Y') as fservicio, date_format(hcitacion, '%H:%i') as hcitacion, ' ORDENES A DESIGNAR' as apellido, 0 as legajo, fservicio as li, fservicio as ls, DATEDIFF(fservicio, fservicio) as dias, date_format(hfinservicio, '%H:%i') as hfinservicio, emp.color, date_format(hllegada, '%H:%i') as hllegada, id_turismo, 0 as id_empleador, date_format(hllegadaplantareal, '%H:%i') as hllegadaplantareal, date_format(hsalidaplantareal, '%H:%i') as hsalidaplantareal, date_format(hfinservicioreal, '%H:%i') as hfinservicioreal, date_format(hcitacionreal, '%H:%i') as hcitacionreal, legEmple FROM (SELECT if (ot.id is null, 0, ot.id) as id_turismo, nombre as servicio, hsalida, hfinservicio, ord.id, id_chofer_1, fservicio, hcitacion, id_cliente, id_estructura_cliente, id_micro, hllegada, hllegadaplantareal, hsalidaplantareal, hfinservicioreal, hcitacionreal, '' as legEmple FROM ordenes ord LEFT JOIN ordenes_turismo ot on ot.id_orden = ord.id and ot.id_estructura_orden = ord.id_estructura WHERE ((fservicio between '2020-11-02' and '2020-11-03') and (id_estructura = 1)) and (not suspendida) and (not borrada) and ((id_chofer_1 is null) or (id_chofer_1 = 0)) and ((id_chofer_2 is null) or (id_chofer_2 = 0)) ) o INNER JOIN clientes c on (c.id = o.id_cliente) and (c.id_estructura = o.id_estructura_cliente) LEFT JOIN unidades un on (un.id = o.id_micro) left join empleadores emp on (emp.id = un.id_propietario) and (emp.id_estructura = un.id_estructura_propietario)) UNION (SELECT interno, upper(c.razon_social)as razon_social, o.id_chofer_1 as id_cond, fservicio as fsrv, upper(servicio) as servicio, date_format(hsalida, '%H:%i') as hsalida, o.id, date_format(fservicio, '%d/%m/%Y') as fservicio, date_format(hcitacion, '%H:%i') as hcitacion, upper(if(emp.id = 1,concat(ch1.apellido, ', ',ch1.nombre), concat('(',emp.razon_social,') ', ch1.apellido, ', ',ch1.nombre))) as apellido, concat(legajo, emp.id) as legajo, fservicio as li, fservicio as ls, DATEDIFF(fservicio, fservicio) as dias, date_format(hfinservicio, '%H:%i') as hfinservicio, empl.color, date_format(hllegada, '%H:%i') as hllegada, id_turismo, ch1.id_empleador,date_format(hllegadaplantareal, '%H:%i') as hllegadaplantareal, date_format(hsalidaplantareal, '%H:%i') as hsalidaplantareal, date_format(hfinservicioreal, '%H:%i') as hfinservicioreal, date_format(hcitacionreal, '%H:%i') as hcitacionreal, legajo as legEmple FROM (SELECT if (ot.id is null, 0, ot.id) as id_turismo, nombre as servicio, hsalida, hfinservicio, ord.id, id_chofer_1, fservicio, hcitacion, id_cliente, id_estructura_cliente, id_micro, hllegada, hllegadaplantareal, hsalidaplantareal, hfinservicioreal, hcitacionreal FROM ordenes ord LEFT JOIN ordenes_turismo ot on ot.id_orden = ord.id and ot.id_estructura_orden = ord.id_estructura WHERE ((fservicio between '2020-11-02' and '2020-11-03') and (id_estructura = 1)) and (not suspendida) and (not borrada) ) o inner JOIN empleados ch1 ON (ch1.id_empleado = o.id_chofer_1) inner join empleadores emp on (emp.id = ch1.id_empleador) inner join clientes c on (c.id = o.id_cliente) and (c.id_estructura = o.id_estructura_cliente) left join unidades un on (un.id = o.id_micro) left join empleadores empl on (empl.id = un.id_propietario) and (empl.id_estructura = un.id_estructura_propietario) where ch1.id_cargo in (1,2,3,4) ) UNION (SELECT interno, upper(c.razon_social)as razon_social, o.id_chofer_2 as id_cond, fservicio as fsrv, upper(servicio) as servicio, date_format(hsalida, '%H:%i') as hsalida, o.id, date_format(fservicio, '%d/%m/%Y') as fservicio, date_format(hcitacion, '%H:%i') as hcitacion, upper(if(emp.id = 1,concat(ch2.apellido, ', ',ch2.nombre), concat('(',emp.razon_social,') ', ch2.apellido, ', ',ch2.nombre))) as apellido, concat(legajo, emp.id) as legajo, fservicio as li, fservicio as ls, DATEDIFF(fservicio, fservicio) as dias, date_format(hfinservicio, '%H:%i') as hfinservicio, empl.color, date_format(hllegada, '%H:%i') as hllegada, id_turismo, ch2.id_empleador,date_format(hllegadaplantareal, '%H:%i') as hllegadaplantareal, date_format(hsalidaplantareal, '%H:%i') as hsalidaplantareal, date_format(hfinservicioreal, '%H:%i') as hfinservicioreal, date_format(hcitacionreal, '%H:%i') as hcitacionreal, ch2.legajo as legEmple FROM (SELECT if (ot.id is null, 0, ot.id) as id_turismo, nombre as servicio,hfinservicio, hsalida, ord.id, id_chofer_2, fservicio, hcitacion, id_cliente, id_estructura_cliente, id_micro, hllegada, hllegadaplantareal, hsalidaplantareal, hfinservicioreal, hcitacionreal FROM ordenes ord LEFT JOIN ordenes_turismo ot on ot.id_orden = ord.id and ot.id_estructura_orden = ord.id_estructura WHERE ((fservicio between '2020-11-02' and '2020-11-03') and (id_estructura = 1)) and (not suspendida) and (not borrada) ) o inner JOIN empleados ch2 ON (ch2.id_empleado = o.id_chofer_2) inner join empleadores emp on emp.id = ch2.id_empleador inner join clientes c on (c.id = o.id_cliente) and (c.id_estructura = o.id_estructura_cliente) left join unidades un on (un.id = o.id_micro) left join empleadores empl on (empl.id = un.id_propietario) and (empl.id_estructura = un.id_estructura_propietario) where ch2.id_cargo in (1,2,3,4) ) UNION ALL (SELECT '' as interno, '' as razon_social, n.id_empleado as id_cond, '2020-11-02' as fsrv, upper(CONCAT(nov_text, ' (',date_format(desde, '%d/%m/%Y'), ' - ', date_format(hasta, '%d/%m/%Y'),')')) as servicio, '00:00' as hsalida, 0 as id, date_format('2020-11-02', '%d/%m/%Y') as fservicio, '00:00' as hcitacion, upper(if(emp.id = 1,concat(em.apellido, ', ',em.nombre), concat('(',emp.razon_social,') ', em.apellido, ', ',em.nombre))) as apellido, concat(legajo, emp.id) as legajo, if (desde < '2020-11-02', '2020-11-02', desde) as li, if (hasta > '2020-11-03', '2020-11-03', hasta) as ls, DATEDIFF(if (hasta > '2020-11-03', '2020-11-03', hasta), if (desde < '2020-11-02', '2020-11-02', desde)) as dias, '00:00' as hfinservicio, 'FFFFFF' as color, '00:00' as hllegada, 0 as id_turismo, em.id_empleador, '00:00' as hllegadaplantareal, '00:00' as hsalidaplantareal, '00:00' as hfinservicioreal, '00:00' as hcitacionreal, legajo as legEmple FROM (SELECT * FROM novedades WHERE ((activa) and((hasta between '2020-11-02' and '2020-11-03') or (desde between '2020-11-02' and '2020-11-03') or ('2020-11-02' between desde and hasta) or ('2020-11-03' between desde and hasta))) ) n inner join cod_novedades cn on cn.id = n.id_novedad inner join empleados em on em.id_empleado = n.id_empleado and em.id_estructura = 1 inner join empleadores emp on emp.id = em.id_empleador where em.id_cargo in (1,2,3,4) ) ) o LEFT JOIN (SELECT id, id_estructura, fecha FROM estadoDiagramasDiarios WHERE id_estructura = 1 AND finalizado = 1) edd ON edd.fecha = o.fsrv order by apellido, id_cond, li, orden";

  $result = mysqli_query($conn, $sql);

  while ($row = mysqli_fetch_array($result))
  {
    $separado_por_comas = implode(",", $row);

    echo $separado_por_comas;
    echo "<br>";
  }


?>

